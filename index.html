<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT</title>

    <style>
       body{
        font-family: system-ui, -apple-system, BlinkMacSystemFont,
         'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
          'Helvetica Neue', sans-serif;
        background: #f0f0f0;
        display: grid;
        place-content: center;
        height: 100dvh;
       }
       main{
        width: 400px;
        max-width: 100%;
        height: 70vh;

        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 8px;
        margin-bottom: 16px;
        
        overflow-y: auto;
       }
       ul{
        display: flex;
        flex-direction: column;
        list-style: none;
        padding: 0;
       }
       .message{
        display: flex;
        flex-direction: column;
        gap: 0px;
        margin: 4px 0;
        padding: 4px 8px;

        span{
            width: 36px;
            height: 36px;
            background: #eee;
            font-size: 12px;   
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 999999px;
        }
        p{
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        &.user{
            align-self: flex-end;
            align-items: flex-end;
            span, p{
                background: #dbeafa;
            }
        }
        &.bot{
            align-self: flex-start;
            span, p {
                background: #d9f7be;
            }
        }
    }
       form, input{
        display: flex;
        
        input{
            border-radius: 999999px;
            flex-grow: 1;
            border: 0;
            padding: 8px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
       }
       button{
        background: #09f;
        border: 0;
        color: white;
        border-radius: 999999px;
        cursor: pointer;
        padding: 8px;
        transition: background 0.2s ease;
        
        &[disabled]{
            background: #ccc;
            opacity: .6;
            pointer-events: none;
        }
        &:hover{
            background: rgb(33, 111, 163);
        }

        
       }
       small{
        font-size: 10px;
        color: #555;
        position: fixed;
        bottom: 10px;
        left: 0px;
        margin: auto;
        width: 400px;
       }
    </style>

    <script type="module">
        import {createMLCEngine} from "https://esm.run/@mlc-ai/web-llm";
    
        const $ = el => document.querySelector(el)
    
        const $form = $('form')
        const $input = $('input')
        const $template = $('#message-template')
        const $messages = $('ul')
        const $container = $('main')
        const $button = $('button') 
        const $info = $('small')
    
        const SELECTED_MODEL = 'gemma-2-2b-it-q4f32_1-MLC'
    
        // Inicializamos el motor del modelo
        const engine = await createMLCEngine(
            SELECTED_MODEL,
            {
                initProgressCallback: (info) => {
                    console.log('initProgressCallback', info)
                    $info.textContent = `${info.text}%`
                }     
            }       
        )
    
        // Array para mantener el contexto de la conversación
        const conversation = []
    
        $form.addEventListener('submit', async event => {
            event.preventDefault()
            const messageText = $input.value.trim()
            if (messageText === '') return
    
            // Añadimos mensaje del usuario
            addMessage(messageText, 'user')
            conversation.push({ role: "user", content: messageText })
    
            $button.setAttribute('disabled', true)
            $input.value = ''
    
            try {
                // Creamos un mensaje vacío para el bot
                const $botMsg = addMessage("", "bot")
    
                let accumulated = ""
    
                // Respuesta en streaming
                const stream = await engine.chat.completions.create({
                    messages: conversation,
                    stream: true
                })
    
                for await (const chunk of stream) {
                    const delta = chunk.choices[0]?.delta?.content || ""
                    accumulated += delta
                    $botMsg.querySelector("p").textContent = accumulated
                    $container.scrollTop = $container.scrollHeight
                }
    
                // Guardamos en historial
                conversation.push({ role: "assistant", content: accumulated })
    
            } catch (err) {
                console.error(err)
                addMessage("⚠️ Error generando respuesta", "bot")
            } finally {
                $button.removeAttribute('disabled')
            }
        })
    
        const addMessage = (text, sender) => {
            const cloneTemplate = $template.content.cloneNode(true)
            const $newMessage = cloneTemplate.querySelector('.message')
    
            const $who = $newMessage.querySelector('span')
            const $text = $newMessage.querySelector('p')
    
            $text.textContent = text
            $who.textContent = sender === 'user' ? 'Tú' : 'GPT'
            $newMessage.classList.add(sender)
    
            $messages.appendChild($newMessage)
            $container.scrollTop = $container.scrollHeight
    
            return $newMessage
        }
    </script>
    
    
    

</head>
<body>
    <main>
        <ul>
            <li class="message bot">
                <span>GPT</span>
                <p>Esta es la respuesta del bot</p>
            </li>
            <li class="message user">
                <span>Tu</span>
            <p>Esta es la respuesta del usuario y es una respuesta muy larga</p>
            </li>
        </ul>
    </main>

    <form>
        <input name="message" placeholder="Escribe tu mensaje aqui...">
        <button type="submit">Enviar</button>
    </form>

    <small>&nbsp;</small>


    <template id="message-template">
        <li class="message">
            <span></span>
            <p></p>
        </li>
    </template>


</body>
</html>